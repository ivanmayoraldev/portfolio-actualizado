---
const GITHUB_USERNAME = "ivanmayoraldev";

let userData: any = null;
let repos: any[] = [];
let events: any[] = [];
let totalStars = 0;
let totalForks = 0;
let totalCommits = 0;
let contributionData: any[] = [];

// Datos de educaci√≥n y certificaciones
const education = [
    {
        title: "Desarrollo de Aplicaciones Multiplataforma",
        institution: "Sinergia FP",
        year: "2025 - Actualidad",
        description: "Acceso a Datos, Programaci√≥n de Servicios y Procesos, Desarrollo de Interfaces, Sistemas de Gesti√≥n Empresarial, Desarrollo M√≥vil.",
    },
    {
        title: "Desarrollo de Aplicaciones Web",
        institution: "CFP JuanXXIII",
        year: "2023 - 2025",
        description: "Frontend y Backend Development, Bases de Datos, Despliegue de Aplicaciones, Usabilidad y Accesibilidad.",
    }
];

// Datos de experiencia laboral
const experience = [
    {
        position: "Desarrollador Backend Trainee",
        company: "Vortex Dimension Digital S.L",
        period: "Septiembre 2025 - Diciembre 2025",
        description:
            "Desarrollo de M√≥dulos Custom en Odoo ERP utilizando Python, XML, PostgreSQL en entorno Ubuntu. Formaci√≥n a empresas de mis proyectos desarrollados. Migraci√≥n de bases de datos y m√≥dulos entre versiones de Odoo.",
        skills: ["Python", "XML", "PostgreSQL", "Ubuntu", "Odoo ERP"],
    }
];

// M√°s informaci√≥n personal
const personalInfo = {
    interests: ["Desarrollo de Software", "Inteligencia Artificial", "Ciberseguridad", "Tecnolog√≠a Blockchain", "Desarrollo M√≥vil"],
    languages: [
        { name: "Espa√±ol", level: "Nativo" },
        { name: "Ingl√©s", level: "C1 Avanzado" },
        { name: "Franc√©s", level: "B1 Intermedio" }
    ],
    certifications: [
        "Certificaci√≥n Python Developer",
        "AWS Cloud Practitioner",
        "Docker Certified Associate",
        "MongoDB Certified Developer"
    ],
    softSkills: ["Trabajo en equipo", "Resoluci√≥n de problemas", "Aprendizaje continuo", "Comunicaci√≥n efectiva", "Liderazgo t√©cnico"]
};

// Funciones auxiliares
function getLanguageColor(lang: string): string {
    const colors: Record<string, string> = {
        JavaScript: "bg-yellow-400",
        Python: "bg-blue-400",
        HTML: "bg-orange-400",
        CSS: "bg-blue-200",
        TypeScript: "bg-blue-500",
        Astro: "bg-purple-500",
    };
    return colors[lang] || "bg-gray-400";
}

function formatDate(dateString: string): string {
    return new Date(dateString).toLocaleDateString('es-ES', { 
        month: 'short', 
        day: 'numeric' 
    });
}

function getEventIcon(type: string): string {
    const icons: Record<string, string> = {
        PushEvent: "üì¶",
        PullRequestEvent: "üîÄ",
        IssuesEvent: "‚ùó",
        CreateEvent: "‚ú®",
        WatchEvent: "‚≠ê",
        ForkEvent: "üç¥",
    };
    return icons[type] || "‚ö°";
}

function getEventDescription(event: any): string {
    const repoName = event.repo.name.split('/')[1];
    switch (event.type) {
        case "PushEvent":
            const commits = event.payload?.commits?.length || 1;
            return `${commits} commit${commits > 1 ? 's' : ''} en ${repoName}`;
        case "CreateEvent":
            return `Cre√≥ ${event.payload?.ref_type} en ${repoName}`;
        case "WatchEvent":
            return `Starred ${repoName}`;
        case "ForkEvent":
            return `Forked ${repoName}`;
        case "PullRequestEvent":
            return `${event.payload?.action} PR en ${repoName}`;
        case "IssuesEvent":
            return `${event.payload?.action} issue en ${repoName}`;
        default:
            return event.type.replace('Event', '');
    }
}

// Generar datos de contribuci√≥n reales desde eventos de GitHub
function generateContributionData(githubEvents: any[]) {
    const data: any = {};
    const today = new Date();
    const startDate = new Date(today);
    startDate.setDate(startDate.getDate() - 364); // √öltimos 365 d√≠as

    // Inicializar todos los d√≠as con 0
    for (let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        data[dateStr] = 0;
    }

    // Contar contribuciones reales desde eventos
    githubEvents.forEach((event: any) => {
        const dateStr = event.created_at.split('T')[0];
        if (data[dateStr] !== undefined) {
            if (event.type === 'PushEvent') {
                data[dateStr] += event.payload?.commits?.length || 1;
            } else {
                data[dateStr] += 1;
            }
        }
    });

    // Convertir a formato de semanas
    const weeks: any[] = [];
    let currentWeek: any[] = [];
    
    for (let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        currentWeek.push({
            date: dateStr,
            count: data[dateStr] || 0
        });
        
        if (currentWeek.length === 7) {
            weeks.push(currentWeek);
            currentWeek = [];
        }
    }
    
    if (currentWeek.length > 0) {
        weeks.push(currentWeek);
    }

    return weeks;
}

// Fetch GitHub
async function fetchGitHubData() {
    console.log("Descargando datos reales de GitHub...");
    try {
        const [userRes, reposRes, eventsRes] = await Promise.all([
            fetch(`https://api.github.com/users/${GITHUB_USERNAME}`, {
                headers: { "User-Agent": "Portfolio-App" },
            }),
            fetch(
                `https://api.github.com/users/${GITHUB_USERNAME}/repos?sort=updated&per_page=100`,
                { headers: { "User-Agent": "Portfolio-App" } },
            ),
            fetch(
                `https://api.github.com/users/${GITHUB_USERNAME}/events/public?per_page=100`,
                { headers: { "User-Agent": "Portfolio-App" } },
            ),
        ]);

        if (userRes.ok) {
            userData = await userRes.json();
            console.log("Usuario cargado:", userData.login);
        }
        
        if (reposRes.ok) {
            repos = await reposRes.json();
            totalStars = repos.reduce(
                (sum: number, r: any) => sum + r.stargazers_count,
                0,
            );
            totalForks = repos.reduce(
                (sum: number, r: any) => sum + r.forks_count,
                0,
            );
            console.log(`Repositorios cargados: ${repos.length}, Stars: ${totalStars}, Forks: ${totalForks}`);
        }
        
        if (eventsRes.ok) {
            events = await eventsRes.json();
            totalCommits = events
                .filter((e: any) => e.type === "PushEvent")
                .reduce((sum: number, e: any) => sum + (e.payload?.commits?.length || 0), 0);
            
            contributionData = generateContributionData(events);
            console.log(`Eventos cargados: ${events.length}, Commits totales: ${totalCommits}`);
        }

    } catch (e) {
        console.error("Error al obtener datos de GitHub:", e);
        // Si falla, inicializar con datos vac√≠os
        repos = [];
        events = [];
        totalStars = 0;
        totalForks = 0;
        totalCommits = 0;
        contributionData = [];
    }
}

await fetchGitHubData();
---

<div class="h-full flex flex-col text-white">
    <!-- Slider Navigation -->
    <div class="flex justify-center gap-1 mb-4 flex-wrap flex-shrink-0">
        <button
            class="slider-nav px-3 py-2 rounded-full text-xs font-medium transition-all duration-200
                   bg-black/5 dark:bg-white/5 hover:bg-black/10 dark:hover:bg-white/10
                   data-[active=true]:bg-black dark:data-[active=true]:bg-white
                   data-[active=true]:text-white dark:data-[active=true]:text-black"
            data-slide="0">‚ÑπÔ∏è Sobre M√≠</button>
        
        <button
            class="slider-nav px-3 py-2 rounded-full text-xs font-medium transition-all duration-200
                   bg-black/5 dark:bg-white/5 hover:bg-black/10 dark:hover:bg-white/10
                   data-[active=true]:bg-black dark:data-[active=true]:bg-white
                   data-[active=true]:text-white dark:data-[active=true]:text-black"
            data-slide="1">üéì Estudios</button>
        <button
            class="slider-nav px-3 py-2 rounded-full text-xs font-medium transition-all duration-200
                   bg-black/5 dark:bg-white/5 hover:bg-black/10 dark:hover:bg-white/10
                   data-[active=true]:bg-black dark:data-[active=true]:bg-white
                   data-[active=true]:text-white dark:data-[active=true]:text-black"
            data-slide="2">üíº Experiencia</button>

        <button
            class="slider-nav px-3 py-2 rounded-full text-xs font-medium transition-all duration-200
                   bg-black/5 dark:bg-white/5 hover:bg-black/10 dark:hover:bg-white/10
                   data-[active=true]:bg-black dark:data-[active=true]:bg-white
                   data-[active=true]:text-white dark:data-[active=true]:text-black"
            data-slide="3"
            data-active="true">üìä Dashboard</button>
        <button
            class="slider-nav px-3 py-2 rounded-full text-xs font-medium transition-all duration-200
                   bg-black/5 dark:bg-white/5 hover:bg-black/10 dark:hover:bg-white/10
                   data-[active=true]:bg-black dark:data-[active=true]:bg-white
                   data-[active=true]:text-white dark:data-[active=true]:text-black"
            data-slide="4">üöÄ Proyectos</button>
    </div>

    <!-- Slider Container -->
    <div class="slider-container relative overflow-hidden flex-1">
        <!-- Slide 0: Dashboard de Actividad -->
        <div class="slider-slide absolute inset-0 transition-transform duration-500 ease-in-out" data-slide="3">
            <div class="space-y-4 h-full overflow-y-auto pr-2">
                <!-- Estad√≠sticas principales -->
                <div class="grid grid-cols-4 gap-2">
                    <div class="text-center p-3 rounded-lg bg-gradient-to-br from-blue-500/10 to-blue-600/5 border border-blue-500/20">
                        <div class="text-2xl font-bold text-blue-400">{repos.length}</div>
                        <div class="text-xs opacity-70">Repos</div>
                    </div>
                    <div class="text-center p-3 rounded-lg bg-gradient-to-br from-yellow-500/10 to-yellow-600/5 border border-yellow-500/20">
                        <div class="text-2xl font-bold text-yellow-400">{totalStars}</div>
                        <div class="text-xs opacity-70">Stars</div>
                    </div>
                    <div class="text-center p-3 rounded-lg bg-gradient-to-br from-purple-500/10 to-purple-600/5 border border-purple-500/20">
                        <div class="text-2xl font-bold text-purple-400">{totalForks}</div>
                        <div class="text-xs opacity-70">Forks</div>
                    </div>
                    <div class="text-center p-3 rounded-lg bg-gradient-to-br from-green-500/10 to-green-600/5 border border-green-500/20">
                        <div class="text-2xl font-bold text-green-400">{totalCommits}</div>
                        <div class="text-xs opacity-70">Commits</div>
                    </div>
                </div>

                <!-- Gr√°fico de contribuciones -->
                {contributionData.length > 0 && (
                    <div class="p-4 rounded-lg border border-white/10 bg-black/20">
                        <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                            üìà Actividad de Contribuci√≥n
                        </h3>
                        <div class="contribution-graph overflow-x-auto pb-2">
                            <div class="flex gap-1">
                                {contributionData.map((week) => (
                                    <div class="flex flex-col gap-1">
                                        {week.map((day: any) => {
                                            const level = day.count === 0 ? 0 : day.count < 3 ? 1 : day.count < 6 ? 2 : 3;
                                            const colors = [
                                                'bg-gray-800',
                                                'bg-green-900/50',
                                                'bg-green-600/60',
                                                'bg-green-500'
                                            ];
                                            return (
                                                <div 
                                                    class={`w-3 h-3 rounded-sm ${colors[level]} hover:ring-2 hover:ring-white/50 transition-all cursor-pointer`}
                                                    title={`${day.count} contributions on ${day.date}`}
                                                />
                                            );
                                        })}
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div class="flex items-center justify-end gap-2 mt-3 text-xs opacity-60">
                            <span>Menos</span>
                            <div class="flex gap-1">
                                <div class="w-3 h-3 rounded-sm bg-gray-800"></div>
                                <div class="w-3 h-3 rounded-sm bg-green-900/50"></div>
                                <div class="w-3 h-3 rounded-sm bg-green-600/60"></div>
                                <div class="w-3 h-3 rounded-sm bg-green-500"></div>
                            </div>
                            <span>M√°s</span>
                        </div>
                    </div>
                )}

                <!-- Actividad reciente -->
                {events.length > 0 && (
                    <div class="p-4 rounded-lg border border-white/10 bg-black/20">
                        <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                            ‚ö° Actividad Reciente
                        </h3>
                        <div class="space-y-2">
                            {events.slice(0, 8).map((event) => (
                                <div class="flex items-start gap-3 p-2 rounded hover:bg-white/5 transition-colors">
                                    <span class="text-lg flex-shrink-0">{getEventIcon(event.type)}</span>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm truncate">{getEventDescription(event)}</p>
                                        <p class="text-xs opacity-50">{formatDate(event.created_at)}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {repos.length === 0 && (
                    <div class="text-center py-8 opacity-60">
                        <p>No se pudieron cargar los datos de GitHub</p>
                        <p class="text-sm mt-2">Verifica la conexi√≥n y el nombre de usuario</p>
                    </div>
                )}
            </div>
        </div>

        <!-- Slide 1: Estudios -->
        <div class="slider-slide absolute inset-0 transition-transform duration-500 ease-in-out translate-x-full" data-slide="1">
            <div class="space-y-4 h-full overflow-y-auto pr-2">
                <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                    üéì Estudios
                </h3>
                <div class="space-y-3">
                    {education.map((edu) => (
                        <div class="p-4 rounded-lg border border-black/10 dark:border-white/10 hover:bg-black/5 dark:hover:bg-white/5 transition-colors">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold">{edu.title}</h4>
                                <span class="text-xs opacity-60 bg-black/5 dark:bg-white/5 px-2 py-1 rounded-full">
                                    {edu.year}
                                </span>
                            </div>
                            <p class="text-sm opacity-70 mb-2">{edu.institution}</p>
                            <p class="text-sm opacity-80">{edu.description}</p>
                        </div>
                    ))}
                </div>

                <h3 class="text-lg font-bold mb-3 flex items-center gap-2 mt-6">
                    üèÜ Certificaciones
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    {personalInfo.certifications.map((cert) => (
                        <div class="p-3 rounded-lg border border-black/10 dark:border-white/10 hover:bg-black/5 dark:hover:bg-white/5 transition-colors">
                            <span class="text-sm font-medium">{cert}</span>
                        </div>
                    ))}
                </div>
            </div>
        </div>

        <!-- Slide 2: Experiencia -->
        <div class="slider-slide absolute inset-0 transition-transform duration-500 ease-in-out translate-x-full" data-slide="2">
            <div class="space-y-4 h-full overflow-y-auto pr-2">
                <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                    üíº Experiencia Laboral
                </h3>
                {experience.map((job) => (
                    <div class="p-4 rounded-lg border border-black/10 dark:border-white/10 hover:bg-black/5 dark:hover:bg-white/5 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold">{job.position}</h4>
                            <span class="text-xs opacity-60 bg-black/5 dark:bg-white/5 px-2 py-1 rounded-full">
                                {job.period}
                            </span>
                        </div>
                        <p class="text-sm opacity-70 mb-2">{job.company}</p>
                        <p class="text-sm opacity-80 mb-3">{job.description}</p>
                        <div class="flex flex-wrap gap-2">
                            {job.skills.map((skill) => (
                                <span class="px-2 py-1 text-xs rounded-full bg-blue-500/10 text-blue-400 font-medium">
                                    {skill}
                                </span>
                            ))}
                        </div>
                    </div>
                ))}
            </div>
        </div>

        <!-- Slide 3: Sobre M√≠ -->
        <div class="slider-slide absolute inset-0 transition-transform duration-500 ease-in-out translate-x-full" data-slide="0">
            <div class="space-y-4 h-full overflow-y-auto pr-2">
                <!-- Intereses -->
                <div>
                    <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                        üí° Intereses
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        {personalInfo.interests.map((interest) => (
                            <span class="px-3 py-2 text-sm rounded-lg bg-gradient-to-r from-purple-500/20 to-pink-500/20 border border-purple-500/30 font-medium">
                                {interest}
                            </span>
                        ))}
                    </div>
                </div>

                <!-- Idiomas -->
                <div>
                    <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                        üåç Idiomas
                    </h3>
                    <div class="space-y-2">
                        {personalInfo.languages.map((lang) => (
                            <div class="p-3 rounded-lg border border-black/10 dark:border-white/10 hover:bg-black/5 dark:hover:bg-white/5 transition-colors">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">{lang.name}</span>
                                    <span class="text-sm opacity-70 bg-black/5 dark:bg-white/5 px-3 py-1 rounded-full">
                                        {lang.level}
                                    </span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                <!-- Soft Skills -->
                <div>
                    <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                        üéØ Soft Skills
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        {personalInfo.softSkills.map((skill) => (
                            <span class="px-3 py-2 text-sm rounded-lg bg-gradient-to-r from-blue-500/20 to-cyan-500/20 border border-blue-500/30 font-medium">
                                {skill}
                            </span>
                        ))}
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 4: Proyectos -->
        <div class="slider-slide absolute inset-0 transition-transform duration-500 ease-in-out translate-x-full" data-slide="4">
            <div class="space-y-4 h-full overflow-y-auto pr-2">
                {repos.length > 0 ? (
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        {repos.slice(0, 20).map((repo) => (
                            <a
                                href={repo.html_url}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="block p-3 rounded-lg border border-black/10 dark:border-white/10
                                       hover:border-black/20 dark:hover:border-white/20 transition-all duration-200 hover:shadow-lg"
                            >
                                <div class="flex items-start justify-between mb-2">
                                    <h3 class="font-semibold text-sm truncate pr-2">{repo.name}</h3>
                                    {repo.stargazers_count > 0 && (
                                        <span class="flex items-center gap-1 text-xs opacity-60 flex-shrink-0">
                                            ‚≠ê {repo.stargazers_count}
                                        </span>
                                    )}
                                </div>
                                <p class="text-sm opacity-70 mb-2 line-clamp-2">
                                    {repo.description || "Sin descripci√≥n"}
                                </p>
                                <div class="flex items-center justify-between">
                                    {repo.language && (
                                        <span class={`px-2 py-1 text-xs rounded-full ${getLanguageColor(repo.language)} text-white font-medium`}>
                                            {repo.language}
                                        </span>
                                    )}
                                    <div class="text-xs opacity-50">
                                        {formatDate(repo.updated_at)}
                                    </div>
                                </div>
                            </a>
                        ))}
                    </div>
                ) : (
                    <div class="text-center py-8 opacity-60">
                        <p>No se pudieron cargar los repositorios</p>
                    </div>
                )}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("astro:page-load", () => {
        const navButtons = document.querySelectorAll(".slider-nav");
        const slides = document.querySelectorAll(".slider-slide");
        let currentSlide = 0;

        function updateSlider() {
            navButtons.forEach((btn, index) => {
                btn.setAttribute("data-active", index === currentSlide ? "true" : "false");
            });

            slides.forEach((slide, index) => {
                const slideElement = slide as HTMLElement;
                if (index === currentSlide) {
                    slideElement.style.transform = "translateX(0)";
                } else if (index < currentSlide) {
                    slideElement.style.transform = "translateX(-100%)";
                } else {
                    slideElement.style.transform = "translateX(100%)";
                }
            });
        }

        navButtons.forEach((button) => {
            button.addEventListener("click", () => {
                const slideIndex = parseInt(button.getAttribute("data-slide") || "0");
                currentSlide = slideIndex;
                updateSlider();
            });
        });

        updateSlider();
    });
</script>

<style>
    .slider-container {
        min-height: 0;
    }

    .slider-slide {
        overflow-y: auto;
        padding-right: 4px;
    }

    .slider-slide::-webkit-scrollbar {
        width: 4px;
    }

    .slider-slide::-webkit-scrollbar-track {
        background: transparent;
    }

    .slider-slide::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .contribution-graph {
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
    }

    .contribution-graph::-webkit-scrollbar {
        height: 4px;
    }

    .contribution-graph::-webkit-scrollbar-track {
        background: transparent;
    }

    .contribution-graph::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
    }
</style>